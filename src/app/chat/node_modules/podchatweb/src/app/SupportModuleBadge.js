// app/index.js
import React, {Component} from "react";
import {connect} from "react-redux";
import classnames from "classnames";

//strings
import strings from "../constants/localization";

//actions
import {chatSupportModuleBadgeShowing} from "../actions/chatActions";
import {threadCreateWithExistThread} from "../actions/threadActions";

//components
import Container from "../../../Talk-ui-kit/src/container";
import {ButtonFloating} from "../../../Talk-ui-kit/src/button";
import Loading, {LoadingBlinkDots} from "../../../Talk-ui-kit/src/loading";
import Image from "../../../Talk-ui-kit/src/image";
import {Text} from "../../../Talk-ui-kit/src/typography";

//styling
import style from "../../styles/app/SupportModuleBadge.scss";
import talkLogo from "../../styles/images/SupportModuleBadge/talk-logo.png";


@connect(store => {
  return {
    chatInstance: store.chatInstance.chatSDK,
    supportMode: store.chatSupportMode
  };
}, null, null, {forwardRef: true})
export default class SupportModuleBadge extends Component {

  constructor(props) {
    super(props);
    this.onShowChatClick = this.onShowChatClick.bind(this);
    this.state = {
      showLoading: true,
      error: false
    }
  }

  componentDidUpdate(oldProps) {
    const {chatInstance, supportMode, dispatch} = this.props;
    if (oldProps.chatInstance !== chatInstance) {
      chatInstance.getThreadInfo({threadIds: [supportMode]}).then(thread => {
        if (!thread) {
          return this.setState({
            showLoading: false,
            error: strings.thereIsNoSuchThreadFound(supportMode)
          })
        }
        dispatch(threadCreateWithExistThread(thread));
        this.setState({
          showLoading: false
        });
        const {chatSupportAutoShowing, chatSupportModuleBadgeShowing: isBadgeShowing} = this.props;
        if (chatSupportAutoShowing) {
          if (isBadgeShowing) {
            this.props.dispatch(chatSupportModuleBadgeShowing(false));
          }
        }
      });
    }
  }

  onShowChatClick() {
    this.props.dispatch(chatSupportModuleBadgeShowing(false));
  }

  render() {
    const {showLoading, error} = this.state;
    const classNames = classnames({
      [style.SupportModuleBadge]: true
    });
    return (
      <ButtonFloating className={classNames} onClick={showLoading || error ? null : this.onShowChatClick}
                      position={{right: 0, bottom: 0}}>
        {showLoading &&
        <Container className={style.SupportModuleBadge__LoadingContainer}>
          <Container center style={{marginTop: "-6px"}}>
            <Loading><LoadingBlinkDots size="sm" invert/></Loading>
          </Container>
        </Container>
        }
        <Image
          className={style.SupportModuleBadge__Image}
          setOnBackground
          src={talkLogo}/>

        {error &&
        <Container className={style.SupportModuleBadge__ErrorContainer}>
          <Text invert>{error}</Text>
        </Container>
        }
      </ButtonFloating>
    );
  }
}
